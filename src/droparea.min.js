/**!
 * Droparea - Makes an easy and intuitive to upload upload files through drag and drop or select methods.
 * Copyright (c) 2015, Rogério Taques.
 *
 * @requires jQuery v1.11 or above
 * @version 1.0.6
 * @cat Plugins/Image
 * @author Rogério Taques (rogerio.taques@gmail.com)
 * @see https://github.com/rogeriotaques/droparea
 */

(function($){"use strict";var defaults={url:'path/to/server/script',upload:true,file_holder:'#file',file_preview:'#file_preview',notification_delay:5000,accepted:'.jpg|.png|.gif',file_max_size:2048,extra_data:[],success:null,i18n:{unable_to_upload:'Unable to upload at this time.<br >Select a file.',wrong_file_type:'Unacceptable file type!<br >Try: %s',wrong_file_size:'Dropped file is too big!<br >Max file size allowed: %s',abort:'Abort',mb:' MB',kb:' KB',percent:'% ',dismiss:'Dismiss',error:'Err: '}},methods={init:function(options){return this.each(function(){var drop_area=$(this),file=null,form_data=null,statusbar=null,o={};o=$.extend({},defaults,options);if($(o.file_holder).length&&$(o.file_preview).length){$(o.file_holder).on('change',function(ev){var oFReader=new FileReader();oFReader.readAsDataURL($(this)[0].files[0]);oFReader.onload=function(oFREvent){$(o.file_preview).animate({opacity:0},'slow',function(){$(this).attr('src',oFREvent.target.result).animate({opacity:1},'slow');drop_area.find('.statusbar.alert-block').fadeOut('slow',function(){$(this).remove()})})}})}drop_area.parent().css('position',drop_area.parent().css('position'));drop_area.on('click',function(ev){ev.stopPropagation();ev.preventDefault();$(o.file_holder).click()}).on('dragenter',function(ev){ev.stopPropagation();ev.preventDefault();drop_area.addClass('droparea-dragging')}).on('dragleave',function(ev){ev.stopPropagation();ev.preventDefault();drop_area.removeClass('droparea-dragging')}).on('dragover',function(ev){ev.stopPropagation();ev.preventDefault();drop_area.addClass('droparea-dragging')}).on('drop',function(ev){ev.preventDefault();drop_area.toggleClass('droparea-dropped droparea-dragging');file=ev.originalEvent.dataTransfer.files[0];if(!o.upload){_createAlertBlock(o,drop_area,o.i18n.unable_to_upload,true,false);$(o.file_holder).click();return}if(o.accepted!==null&&typeof o.accepted!='boolean'){if(o.accepted.toLowerCase().indexOf(file.name.substr(file.name.lastIndexOf('.')).toLowerCase())===-1){_createAlertBlock(o,drop_area,o.i18n.wrong_file_type.replace('%s','<b >'+o.accepted.split('|').join('</b> or <b >')+'</b>'));return}}if((file.size/1024)>o.file_max_size){_createAlertBlock(o,drop_area,o.i18n.wrong_file_size.replace('%s','<b >'+o.file_max_size+' '+o.i18n.kb+'</b>'));return}form_data=new FormData();form_data.append(o.file_holder.replace('#',''),file);if(o.extra_data!==null){for(var i in o.extra_data){if($('#'+o.extra_data[i].replace('#','')).length){form_data.append(o.extra_data[i].replace('#',''),$('#'+o.extra_data[i].replace('#','')).val())}}}statusbar=new _createStatusBar(drop_area,o);statusbar.setFileNameSize(file.name,file.size);_sendFileToServer(form_data,statusbar,drop_area,file,o)})})}},_sent=0,_createStatusBar=function(obj,o){_sent+=1;this.statusbar=$('<div class="statusbar statusbar-'+_sent+'"></div>');this.filename=$('<div class="filename"></div>').appendTo(this.statusbar);this.size=$('<div class="filesize"></div>').appendTo(this.statusbar);this.progressBar=$('<div class="progressbar"><div></div></div>').appendTo(this.statusbar);this.progressBarWidth=0;this.abort=$('<a class="btn abort">'+o.i18n.abort+'</div>').appendTo(this.statusbar);this.statusbar.css({'width':obj.outerWidth(),'height':obj.outerHeight(),'top':obj.offset().top,'left':obj.offset().left});obj.append(this.statusbar);this.setFileNameSize=function(name,size){var size_str='',size_kb=(size/1024);if(parseInt(size_kb)>1024){size_str=(size_kb/1024).toFixed(2)+o.i18n.mb}else{size_str=size_kb.toFixed(2)+o.i18n.kb}this.filename.html(name);this.size.html(size_str)};this.setProgress=function(progress){this.progressBarWidth=progress*this.progressBar.width()/100;this.progressBar.find('div').animate({width:this.progressBarWidth},10).html(progress+o.i18n.percent);if(parseInt(progress)>=100){this.abort.hide()}};this.setAbort=function(jqxhr){this.abort.on('click',function(ev){ev.preventDefault();jqxhr.abort();this.statusbar.hide()})}},_createAlertBlock=function(o,target,msg,dismissable,autohide){dismissable=(typeof dismissable!='undefined'?dismissable:true);autohide=(typeof autohide!='undefined'?autohide:true);var alertblock=$('<div class="statusbar alert-block"></div>'),filename=$('<div class="filename"></div>').html(msg).appendTo(alertblock),dismiss=$('<button class="btn dismiss"></button>').html(o.i18n.dismiss);alertblock.css({'width':target.outerWidth(),'height':target.outerHeight(),'top':target.offset().top,'left':target.offset().left});target.append(alertblock);if(dismissable){dismiss.on('click',function(ev){ev.stopPropagation();ev.preventDefault();alertblock.fadeOut('fast',function(){$(this).remove()})}).appendTo(alertblock)}if(autohide){setTimeout(function(){alertblock.fadeOut('fast',function(){$(this).remove()})},o.notification_delay)}},_sendFileToServer=function(form_data,status,drop_area,file,o){var jqXHR=$.ajax({xhr:function(){var xhrobj=$.ajaxSettings.xhr();if(xhrobj.upload){xhrobj.upload.addEventListener('progress',function(ev){var percent=0,position=(ev.loaded||ev.position),total=ev.total;if(ev.lengthComputable){percent=Math.ceil(position/total*100)}status.setProgress(percent)},false)}return xhrobj},url:o.url,type:"POST",contentType:false,processData:false,cache:false,data:form_data,success:function(r){r=$.parseJSON(r);status.setProgress(100);if(o.success!==null&&$.isFunction(o.success)){o.success(r,(typeof r.file_name!='undefined'?r.file_name:null),file)}drop_area.removeClass('droparea-dropped')},error:function(jqXHR,textStatus,errorThrown){status.progressBar.addClass('droparea-fail');status.progressBar.find('div:first').html(o.i18n.error+errorThrown)},complete:function(jqXHR,textStatus){setTimeout(function(){status.statusbar.fadeOut('fast',function(){$(this).remove()})},o.notification_delay)}});status.setAbort(jqXHR)};$.fn.droparea=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof method==='object'||!method){return methods.init.apply(this,arguments)}else{$.error('Method '+method+' does not exist on jQuery.droparea()')}}})(jQuery);
